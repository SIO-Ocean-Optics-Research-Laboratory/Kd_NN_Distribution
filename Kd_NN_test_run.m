%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%Test script for the Kd NN code. The Kd NN code is run for 100 specified
%inputs of multispectral remote-sensing reflectance (Rrs) and solar zenith
%angles (sza). The resulting output from the test script is saved to
%Kd_NN_test_run_YYYYMMDD.xls for comparison with the provided
%output file Kd_NN_test_run.xls
%
%Reference: Jamet, C., H., Loisel and D., Dessailly (2012). Retrieval of
%the spectral diffuse attenuation coefficient Kd(l) in open and coastal
%ocean waters using a neural network inversion, Journal of Geophysical
%Research-Oceans, 117, C10023, doi:10.1029/2012JC008076
%
%%Created: October 14, 2022
%Completed: October 17, 2022
%Updates: N/A
%
%M. Kehrli, R. A. Reynolds, and D. Stramski 
%Ocean Optics Research Laboratory, Scripps Institution of Oceanography
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

%clear command window and workspace; close figures
clc; clearvars; close all;

%define input parameters:

%input Rrs [sr^-1]
input_Rrs = [0.00663061627778120,0.00569886961307466,...
    0.00261783091270704,0.00206376550494829,0.000155664525215032;...
    0.00278698717627185,0.00555055435696759,0.00965557516418457,...
    0.0114125090066875,0.00402413455723548;0.00141564415316463,...
    0.00176171117919528,0.00344245381991388,0.00405858878523525,...
    0.00222853283057284;0.00622535698670177,0.0104346876270010,...
    0.0157018006006571,0.0171360307115865,0.00412390445836089;...
    0.00521615046356554,0.00812765366909679,0.0116978390504700,...
    0.0118663916123288,0.00211278155830874;0.00497792795196594,...
    0.00766359661736594,0.0110114643829118,0.0111614617112085,...
    0.00202954049101727;0.00561705976474636,0.00967724866309943,...
    0.0123609091276471,0.0125999211757100,0.00187990289666272;...
    0.00887557231544904,0.00814615517193099,0.00393742604356154,...
    0.00312412923434840,0.000252669403324207;0.00184045475411603,...
    0.00360492185284056,0.00570124712645214,0.00655602211294479,...
    0.00186449816072657;0.00744260533821507,0.00554463614469000,...
    0.00210980875072711,0.00161163268507008,5.70318753257830e-05;...
    0.00364816623751616,0.00638687655628102,0.00960659258793171,...
    0.0100114277052928,0.00166109577399138;0.00269648606026268,...
    0.00426014212534631,0.00616830294171172,0.00670887853324342,...
    0.00154379168637871;0.00469887886203726,0.00648398147399403,...
    0.00665438330593373,0.00610000644962224,0.000758300465710595;...
    0.00699416683872231,0.00991866780787578,0.00899247373959475,...
    0.00805567722944184,0.000916304639281846;0.00224751339016786,...
    0.00402565284777883,0.00677299982201064,0.00837144419276763,...
    0.00390962059039067;0.00190799457279900,0.00390418216736147,...
    0.00671275873120119,0.00790312268888099,0.00288934959596305;...
    0.00165440503290757,0.00299056793873173,0.00606426698955819,...
    0.00700056038820081,0.00178608168973419;0.00627183916499809,...
    0.00582247571101301,0.00263066768185676,0.00206526424323706,...
    0.000152805007385994;0.00555401405593558,0.00430335038014337,...
    0.00175410499355664,0.00136383777620645,9.06084732584692e-05;...
    0.00561705976474636,0.00967724866309943,0.0123609091276471,...
    0.0125999211757100,0.00187990289666272;0.0104277981817029,...
    0.00672013805822284,0.00242609718935802,0.00187303739752687,...
    0.000132276709530967;0.00881566570234884,0.0114501531025389,...
    0.00957177613343274,0.00832722750732921,0.000799560517616530;...
    0.00112117275952056,0.00171618420431667,0.00218889310471185,...
    0.00221456691062423,0.000402489541874891;0.00816959942447379,...
    0.0111115764698362,0.00941788353067031,0.00841215194881588,...
    0.000847899061124180;0.00122593821353192,0.00238290605935982,...
    0.00468189626555435,0.00596356526500665,0.00343128289729349;...
    0.00161780377368775,0.00282460282182722,0.00478936878399368,...
    0.00575814051033902,0.00552813730876720;0.00336467705378956,...
    0.00514619611014346,0.00688117669881443,0.00733500721802258,...
    0.00187482378936931;0.0115538613417542,0.0106013104223149,...
    0.00488423549337016,0.00382202800603245,0.000304572792058278;...
    0.00664200000000000,0.0117606800000000,0.0144366000000000,...
    0.0156798000000000,0.00627442000000000;0.00522217412396095,...
    0.00674578608913026,0.00660517085925629,0.00622576424702567,...
    0.000797005945266310;0.000917153912814709,0.00169430390818238,...
    0.00326256661881123,0.00416416989109053,0.00485784279766535;...
    0.00464216579658900,0.00729993328021850,0.0103831884777310,...
    0.0122524869244531,0.00362992307656753;0.00247151831450256,...
    0.00459426574916097,0.00758304290225450,0.00881743162838487,...
    0.00283049814297817;0.00648211485192837,0.00961461741900283,...
    0.0119878254626547,0.0121702118037606,0.00218658080061416;...
    0.00209850160092417,0.00389673485221374,0.00632900406388094,...
    0.00743208468410311,0.00272231612616317;0.00246034959506063,...
    0.00302000969493852,0.00232427494835408,0.00198865973352391,...
    0.000182729894129148;0.00323564644428006,0.00351956101689283,...
    0.00219849110360025,0.00180705419905392,0.000189570013355691;...
    0.00825093201825468,0.00589745035701764,0.00216306716107790,...
    0.00166109641271733,0.000115458520765528;0.00258783221525963,...
    0.00398739664439906,0.00684332242674100,0.00823314745587755,...
    0.00310924886735910;0.00253218538847844,0.00555509728848399,...
    0.0119114503658823,0.0155845517602727,0.0109976704357252;...
    0.0101384701808441,0.00683917807981082,0.00253697176255398,...
    0.00195006782350894,0.000133138471955731;0.00203898343185239,...
    0.00387488741202957,0.00637816360817108,0.00751357879018752,...
    0.00267609894241770;0.00405435740919386,0.00692659784422380,...
    0.0125239395428043,0.0156375895842241,0.00976286734966452;...
    0.00172200033956428,0.00298436651873827,0.00402619014571566,...
    0.00427008401718304,0.000874470651843892;0.0132885254091587,...
    0.00820888694898182,0.00280365519999264,0.00214244234007277,...
    0.000146798139776705;0.00455669223805328,0.00780153763901032,...
    0.0104910257752050,0.0117077852601408,0.00326881950241219;...
    0.000638010000000000,0.00118651200000000,0.00194708000000000,...
    0.00223020000000000,0.000701356400000000;0.00213006676524486,...
    0.00280862380796082,0.00270692439202271,0.00251393871940486,...
    0.000328134257115489;0.00440156411570024,0.00553588788518784,...
    0.00531282873050643,0.00489595775220401,0.000626726017619055;...
    0.00420940000000000,0.00695227200000000,0.00850276000000000,...
    0.00898320000000000,0.00212895400000000;0.00520987468049248,...
    0.00492386453164563,0.00313851288282914,0.00264461095750800,...
    0.000259684426529864;0.00163461808559202,0.00297673575063394,...
    0.00431281113691863,0.00469828364615637,0.00103115831710779;...
    0.00187816906164767,0.00452851403692463,0.0101154622385419,...
    0.0132342363911159,0.00698558790217795;0.00362974890624959,...
    0.00595643153223947,0.00775313168258731,0.00817599243975921,...
    0.00155677375903734;0.00694315187206306,0.0122855292272130,...
    0.0172772298702483,0.0188161470728189,0.00480201353815852;...
    0.00622535698670177,0.0104346876270010,0.0157018006006571,...
    0.0171360307115865,0.00412390445836089;0.00409450000000000,...
    0.00858529600000000,0.0138104000000000,0.0161480000000000,...
    0.00990092400000000;0.00191821274247198,0.00358868129531781,...
    0.00632851117934479,0.00772219115104396,0.00327377845523182;...
    0.00803315317242995,0.0108692481299887,0.00917924924939830,...
    0.00819221905437402,0.000860289334244823;0.0105104141906774,...
    0.00730146869982543,0.00276184258098452,0.00214110929008105,...
    0.000157516095178496;0.00453741442958510,0.00616040656375171,...
    0.00731937684211551,0.00750155060909554,0.00139556765885881;...
    0.00159830868562596,0.00280256176509238,0.00465476185667246,...
    0.00522962146645921,0.00152884078093032;0.00615852672527960,...
    0.0102536121721272,0.0154039041526865,0.0168107567015353,...
    0.00410058874908857;0.00750462902957139,0.0127815927545866,...
    0.0207366604700738,0.0242449694015631,0.00758418489842674;...
    0.00202757526027510,0.00289768614571361,0.00349324546445555,...
    0.00342828259774021,0.000484018604180011;0.00395738020996767,...
    0.00643026695291472,0.00786817898014590,0.00793392284751532,...
    0.00123362205709573;0.000840807716590629,0.00162687276043388,...
    0.00236730643109466,0.00269590275122654,0.000724634885807160;...
    0.00314415917875868,0.00429755393676742,0.00397548891246760,...
    0.00352304392427096,0.000386379732180321;0.00478268747133068,...
    0.00642058431939478,0.00578022057689320,0.00514735181500472,...
    0.000562154479830706;0.00308368938727872,0.00469411946187689,...
    0.00517861256642510,0.00524580091735901,0.00134386870982527;...
    0.00230357140187655,0.00370266292924342,0.00554568798215219,...
    0.00625992535891553,0.00247393045131028;0.00200749052485981,...
    0.00275637911782057,0.00289557674196695,0.00286271428507464,...
    0.000536985918966844;0.00866353482631638,0.00796584979367656,...
    0.00377388761239697,0.00301107951503736,0.000261157952161265;...
    0.00314415917875868,0.00429755393676742,0.00397548891246760,...
    0.00352304392427096,0.000386379732180321;0.00796930941835075,...
    0.00574529202077654,0.00233608566490819,0.00181415972634225,...
    0.000127501127534978;0.00655531154788774,0.00562500678518747,...
    0.00254390601525429,0.00200885792131404,0.000158578461670976;...
    0.00197671794069238,0.00465805780837233,0.0102407925596773,...
    0.0134489856113089,0.00908446048553582;0.00284987090278607,...
    0.00557129166108717,0.00980300861196426,0.0115529444991199,...
    0.00424007739621493;0.000929884412063367,0.00142158024873543,...
    0.00205441114443840,0.00228852116470130,0.000844904274819993;...
    0.00511904812523560,0.00791627810505150,0.0113844766066087,...
    0.0115436642078764,0.00208751168736677;0.00645140523379125,...
    0.0103434635824032,0.0131043336410388,0.0145674755909355,...
    0.00509646806617128;0.0136986000241548,0.0155456201135426,...
    0.0124509090290279,0.0109639230039553,0.00109549627851454;...
    0.00190799457279900,0.00390418216736147,0.00671275873120119,...
    0.00790312268888099,0.00288934959596305;0.00201890402738426,...
    0.00293706690118022,0.00394483211142191,0.00430047617231556,...
    0.00132190000509073;0.00180703547537470,0.00289055913433363,...
    0.00430207055950900,0.00475223759694577,0.00136880330219927;...
    0.00707102264259735,0.00773582570902863,0.00430259936837243,...
    0.00348698386394409,0.000306828724602057;0.00236106601972983,...
    0.00378269771010491,0.00552392079742446,0.00608584443892497,...
    0.00166071379169253;0.00564294611274294,0.00775612576578324,...
    0.00658557405574582,0.00577920546907693,0.000587513769451671;...
    0.00639438575820731,0.0107454285014534,0.0161094594254016,...
    0.0175597774850311,0.00425144621487474;0.00103756796717540,...
    0.00150825589306410,0.00204344302345769,0.00214710802891093,...
    0.000534153951839404;0.00158938215564285,0.00320102540969137,...
    0.00602295827341114,0.00750334991918437,0.00458422338296835;...
    0.00127466364276247,0.00240005044978750,0.00402094403237732,...
    0.00478047632391908,0.00171431595879987;0.00730704476152018,...
    0.00632148483547197,0.00284923662339973,0.00225959241826714,...
    0.000176251147007756;0.00401716807608683,0.00634192716998643,...
    0.00877576560762459,0.00926279847449899,0.00178490082407847;...
    0.00707102264259735,0.00773582570902863,0.00430259936837243,...
    0.00348698386394409,0.000306828724602057;0.00183741357733902,...
    0.00301707321815067,0.00456952155846802,0.00506466506075188,...
    0.00141181881086600;0.00394584385451146,0.00580954821984158,...
    0.00743683999208845,0.00763867060537905,0.00149727541130951;...
    0.00254950000000000,0.00523120800000000,0.00780992000000000,...
    0.00895482000000000,0.00430961800000000;0.000808414822326384,...
    0.00133501192657008,0.00214783645033701,0.00252247284630359,...
    0.00166264353418483;0.00489507612941246,0.00559138801542992,...
    0.00550275864529340,0.00518392703615246,0.000703464363357699];

%input solar zenith angle [deg]
input_sza = [30;60;50.9989738000001;30;60;0;60;30;30;52;0;30;30;0;30;...
    30;30;30;0;60;30;59.9999999999999;0;60;0;59.9999999999999;60;30;0;...
    60;60;60;60;0;0;30;48.4759674000000;60;0;0;60;30;0;0;60;0;30;60;0;...
    30;0;60;30;30;30;30;60;0;30;30;0;60;0;30;30;60;30;60;60;...
    21.9333954000000;60;60;0;60;30;30;60;0;30;30;30;0;30;...
    27.9899063000000;0;60;0;30;60;60;0;60;0;30;60;60;0;60;60;0];

%output wavelengths [nm]
input_lambda = [430;531;645;570;520;430;700;400;488;555;620;500;650;610;590;...
    555;600;460;480;690;490;530;650;531;650;665;530;400;645;560;650;665;...
    420;570;700;500;488;460;590;610;690;412;667;450;400;650;547;520;520;...
    667;650;480;412;660;420;450;488;530;531;560;443;500;680;510;547;480;...
    560;488;660;555;667;480;570;430;460;590;555;700;560;667;667;640;450;...
    488;488;430;570;667;670;560;488;580;520;488;650;690;420;469;630;480];

%input Kd NN LUTs
load 'Kd_NN_LUT.mat'

%calculate Kd using NN
Kd_est=Kd_NN(input_Rrs,input_sza,input_lambda,Kd_NN_LUT);

%save inputs and outputs into an excel file
T = table(input_Rrs(:,1),input_Rrs(:,2), input_Rrs(:,3), input_Rrs(:,4), ...
    input_Rrs(:,5), input_sza, input_lambda, Kd_est);
T.Properties.VariableNames = {'Input Rrs(443) [1/sr]'...
'Input Rrs(488) [1/sr]' 'Input Rrs(531) [1/sr]' 'Input Rrs(547) [1/sr]' ...
'Input Rrs(667) [1/sr]' 'Input sza [deg]' 'Output Wavelength [nm]'...
'Output Kd [1/m]'};
FormatOut = 'YYYYMMDD';
outfile=[cd '\Kd_NN_test_run' datestr(datetime,FormatOut)];
writetable(T,outfile,'FileType','spreadsheet','Sheet','Kd_NN_Output')
